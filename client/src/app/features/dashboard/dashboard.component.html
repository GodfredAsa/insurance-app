<div class="ifrs17-report wrap">
  <!-- Report header (index.html style) -->
  <header class="ifrs-header">
    <h1>IFRS 17 — Sample Data Analysis</h1>
    <p>Reporting date: {{ reportingDate }} | Currency: {{ currency }} | Portfolios: {{ portfolios.join(', ') }}</p>
  </header>

  @if (currentSection() === 'summary') {
  <!-- Section: Summary & charts -->
  <section id="dashboard" class="ifrs-section">
    <h2 class="ifrs-section-title">Insurance performance summary &amp; charts</h2>
    <p class="ifrs-desc">Key metrics and visual comparison across portfolios (Motor, Property, Life). All amounts in {{ currency }}.</p>

    <div class="dashboard-cards">
      <div class="card">
        <div class="label">Insurance liability</div>
        <div class="value">{{ fmtNum(totalLiabilityClose) }} <small>{{ currency }}</small></div>
        @if (liabilityTrendPct != null) {
          <div class="trend" [ngClass]="liabilityTrendPct >= 0 ? 'up' : 'down'">{{ trendText(liabilityTrendPct) }}</div>
        }
      </div>
      <div class="card">
        <div class="label">Reinsurance asset</div>
        <div class="value">{{ fmtNum(totalReinAsset) }} <small>{{ currency }}</small></div>
      </div>
      <div class="card">
        <div class="label">Closing CSM</div>
        <div class="value">{{ fmtNum(totalCSMClose) }} <small>{{ currency }}</small></div>
        @if (csmTrendPct != null) {
          <div class="trend" [ngClass]="csmTrendPct >= 0 ? 'up' : 'down'">{{ trendText(csmTrendPct) }}</div>
        }
      </div>
      <div class="card">
        <div class="label">Gross premium</div>
        <div class="value">{{ fmtNum(totalGross) }} <small>{{ currency }}</small></div>
      </div>
      <div class="card">
        <div class="label">Net premium</div>
        <div class="value">{{ fmtNum(totalNet) }} <small>{{ currency }}</small></div>
      </div>
      <div class="card">
        <div class="label">Claims incurred</div>
        <div class="value">{{ fmtNum(totalIncurred) }} <small>{{ currency }}</small></div>
      </div>
      <div class="card">
        <div class="label">Loss ratio</div>
        <div class="value">{{ lossRatioPct }} <small>%</small></div>
      </div>
      <div class="card">
        <div class="label">Contracts</div>
        <div class="value">{{ contractsCount }}</div>
      </div>
    </div>

    <h3 class="ifrs-h3">Performance by portfolio</h3>
    <div class="chart-row">
      <div class="chart-box">
        <h4 class="chart-box-title">Gross premium by portfolio</h4>
        <app-donut-chart [data]="donutPremiumData" [chartHeight]="220" />
      </div>
      <div class="chart-box">
        <h4 class="chart-box-title">Closing liability by portfolio</h4>
        <app-donut-chart [data]="donutLiabilityData" [chartHeight]="220" />
      </div>
    </div>
    <div class="chart-row">
      <div class="chart-box">
        <h4 class="chart-box-title">Premium vs claims by portfolio</h4>
        <app-bar-chart [series]="barPremiumClaimsSeries" [xLabels]="portfolios" height="260px" />
      </div>
      <div class="chart-box">
        <h4 class="chart-box-title">Opening vs closing liability</h4>
        <app-bar-chart [series]="barOpeningClosingSeries" [xLabels]="portfolios" height="260px" />
      </div>
    </div>
    <h3 class="ifrs-h3">Trend analysis</h3>
    <div class="chart-row">
      <div class="chart-box">
        <h4 class="chart-box-title">Liability trend by cohort year</h4>
        <app-line-chart [series]="lineLiabilitySeries" [xLabels]="cohortLabels" height="260px" />
      </div>
      <div class="chart-box">
        <h4 class="chart-box-title">CSM trend by cohort year</h4>
        <app-line-chart [series]="lineCsmSeries" [xLabels]="cohortLabels" height="260px" />
      </div>
    </div>
    <h3 class="ifrs-h3">Portfolio comparison</h3>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead>
          <tr>
            <th>Portfolio</th><th>Contracts</th><th>Gross premium</th><th>Claims</th><th>Loss %</th><th>Closing liability</th><th>Closing CSM</th>
          </tr>
        </thead>
        <tbody>
          @for (row of portfolioComparison; track row.portfolio) {
            <tr>
              <td>{{ row.portfolio }}</td>
              <td class="num">{{ row.contracts }}</td>
              <td class="num">{{ fmtNum(row.gross_premium) }}</td>
              <td class="num">{{ fmtNum(row.claims) }}</td>
              <td class="num">{{ row.loss_ratio_pct }}</td>
              <td class="num">{{ fmtNum(row.closing_liability) }}</td>
              <td class="num">{{ fmtNum(row.closing_csm) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'liability') {
  <!-- 1. Liability reconciliation -->
  <section id="liability" class="ifrs-section">
    <h2 class="ifrs-section-title">1. Insurance contract liability reconciliation</h2>
    <p class="ifrs-desc">Reconciliation of carrying amount from opening to closing by portfolio and cohort.</p>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead>
          <tr>
            <th>Portfolio</th><th>Cohort</th><th>Opening</th><th>New contracts</th><th>Premiums rec'd</th><th>Claims incurred</th><th>CSM release</th><th>Experience var.</th><th>Closing</th>
          </tr>
        </thead>
        <tbody>
          @for (r of lm; track r.portfolio + r.cohort_year) {
            <tr>
              <td>{{ r.portfolio }}</td><td>{{ r.cohort_year }}</td>
              <td class="num">{{ fmtNum(r.opening_balance) }}</td><td class="num">{{ fmtNum(r.new_contracts) }}</td>
              <td class="num">{{ fmtNum(r.premiums_received) }}</td><td class="num">{{ fmtNum(r.claims_incurred) }}</td>
              <td class="num">{{ fmtNum(r.csm_release) }}</td><td class="num">{{ fmtNum(r.experience_variance) }}</td>
              <td class="num">{{ fmtNum(r.closing_balance) }}</td>
            </tr>
          }
          <tr class="total">
            <td>Total</td><td></td>
            <td class="num">{{ fmtNum(totalLiabilityOpen) }}</td>
            <td class="num">{{ fmtNum(liabilityTotals.new_contracts) }}</td>
            <td class="num">{{ fmtNum(liabilityTotals.premiums_received) }}</td>
            <td class="num">{{ fmtNum(liabilityTotals.claims_incurred) }}</td>
            <td class="num">{{ fmtNum(liabilityTotals.csm_release) }}</td>
            <td class="num">{{ fmtNum(liabilityTotals.experience_variance) }}</td>
            <td class="num">{{ fmtNum(totalLiabilityClose) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'csm') {
  <section id="csm" class="ifrs-section">
    <h2 class="ifrs-section-title">2. Contractual service margin (CSM) reconciliation</h2>
    <p class="ifrs-desc">CSM from opening to closing: initial recognition, changes in estimates, release to P&amp;L.</p>
    <div class="summary-box">Total insurance revenue from CSM release in period: <strong>{{ fmtNum(totalCSMRelease) }} {{ currency }}</strong></div>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead>
          <tr>
            <th>Portfolio</th><th>Cohort</th><th>Opening CSM</th><th>Initial recognition</th><th>Changes in estimates</th><th>CSM release to P&L</th><th>Closing CSM</th>
          </tr>
        </thead>
        <tbody>
          @for (r of cm; track r.portfolio + r.cohort_year) {
            <tr>
              <td>{{ r.portfolio }}</td><td>{{ r.cohort_year }}</td>
              <td class="num">{{ fmtNum(r.opening_csm) }}</td><td class="num">{{ fmtNum(r.initial_recognition) }}</td>
              <td class="num">{{ fmtNum(r.changes_in_estimates) }}</td><td class="num">{{ fmtNum(r.csm_release_to_pl) }}</td>
              <td class="num">{{ fmtNum(r.closing_csm) }}</td>
            </tr>
          }
          <tr class="total">
            <td>Total</td><td></td>
            <td class="num">{{ fmtNum(csmTotals.opening_csm) }}</td>
            <td class="num">{{ fmtNum(csmTotals.initial_recognition) }}</td>
            <td class="num">{{ fmtNum(csmTotals.changes_in_estimates) }}</td>
            <td class="num">{{ fmtNum(totalCSMRelease) }}</td>
            <td class="num">{{ fmtNum(totalCSMClose) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'revenue-expense') {
  <!-- 3. Revenue & expense -->
  <section id="revenue-expense" class="ifrs-section">
    <h2 class="ifrs-section-title">3. Insurance revenue and insurance service expense</h2>
    <p class="ifrs-desc">Amounts recognised in P&amp;L: revenue (CSM release) and expenses (claims, acquisition).</p>
    <div class="summary-box"><strong>Insurance revenue (CSM release):</strong> {{ fmtNum(totalCSMRelease) }} {{ currency }}</div>
    <div class="summary-box"><strong>Insurance service expense — Claims incurred:</strong> {{ fmtNum(totalIncurred) }} {{ currency }}</div>
    <div class="summary-box"><strong>Insurance service expense — Acquisition costs (total):</strong> {{ fmtNum(totalAcq) }} {{ currency }}</div>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Contract</th><th>Commission</th><th>Underwriting</th><th>Total</th></tr></thead>
        <tbody>
          @for (r of ac; track r.contract_id) {
            <tr>
              <td>{{ r.contract_id }}</td>
              <td class="num">{{ fmtNum(r.commission) }}</td>
              <td class="num">{{ fmtNum(r.underwriting_cost) }}</td>
              <td class="num">{{ fmtNum(r.total) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'development') {
  <!-- 4. Development -->
  <section id="development" class="ifrs-section">
    <h2 class="ifrs-section-title">4. Premium and claims development (run-off)</h2>
    <p class="ifrs-desc">Premium by contract; claims development triangle and loss emergence.</p>
    <h3 class="ifrs-h3">Premium by contract</h3>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Contract</th><th>Period</th><th>Gross</th><th>Ceded</th><th>Net</th><th>Received date</th></tr></thead>
        <tbody>
          @for (r of prem; track r.contract_id + r.period) {
            <tr>
              <td>{{ r.contract_id }}</td><td>{{ r.period }}</td>
              <td class="num">{{ fmtNum(r.gross_premium) }}</td><td class="num">{{ fmtNum(r.ceded_premium) }}</td>
              <td class="num">{{ fmtNum(r.net_premium) }}</td><td>{{ r.received_date }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    <h3 class="ifrs-h3">Claims development (incremental)</h3>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Cohort</th><th>Dev. Y1</th><th>Dev. Y2</th><th>Dev. Y3</th><th>Incremental total</th></tr></thead>
        <tbody>
          @for (r of dev; track r.cohort_year) {
            <tr>
              <td>{{ r.cohort_year }}</td>
              <td class="num">{{ fmtNum(r.development_year_1) }}</td>
              <td class="num">{{ fmtNum(r.development_year_2) }}</td>
              <td class="num">{{ fmtNum(r.development_year_3) }}</td>
              <td class="num">{{ fmtNum(r.incremental_claims) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'experience') {
  <!-- 5. Experience -->
  <section id="experience" class="ifrs-section">
    <h2 class="ifrs-section-title">5. Experience variance and assumption change analysis</h2>
    <p class="ifrs-desc">Experience variance and changes in estimates by portfolio/cohort.</p>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Portfolio</th><th>Cohort</th><th>Experience variance (liability)</th><th>Changes in estimates (CSM)</th></tr></thead>
        <tbody>
          @for (lr of lm; track lr.portfolio + lr.cohort_year) {
            <tr>
              <td>{{ lr.portfolio }}</td><td>{{ lr.cohort_year }}</td>
              <td class="num">{{ fmtNum(lr.experience_variance) }}</td>
              <td class="num">{{ fmtNum(getCsmChangesInEstimates(lr.portfolio, lr.cohort_year)) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'reinsurance') {
  <!-- 6. Reinsurance -->
  <section id="reinsurance" class="ifrs-section">
    <h2 class="ifrs-section-title">6. Reinsurance and net exposure</h2>
    <p class="ifrs-desc">Ceded premium, recoveries, reinsurance asset by contract.</p>
    <div class="summary-box">
      Total ceded premium (YTD): <strong>{{ fmtNum(totalCededYtd) }} {{ currency }}</strong> |
      Recoveries YTD: <strong>{{ fmtNum(totalRecoveries) }} {{ currency }}</strong> |
      Reinsurance asset: <strong>{{ fmtNum(totalReinAsset) }} {{ currency }}</strong>
    </div>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Contract</th><th>Reinsurer</th><th>Ceded premium YTD</th><th>Recoveries YTD</th><th>Reinsurance asset</th></tr></thead>
        <tbody>
          @for (r of rein; track r.contract_id) {
            <tr>
              <td>{{ r.contract_id }}</td><td>{{ r.reinsurer }}</td>
              <td class="num">{{ fmtNum(r.ceded_premium_ytd) }}</td><td class="num">{{ fmtNum(r.recoveries_ytd) }}</td>
              <td class="num">{{ fmtNum(r.reinsurance_asset_balance) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'concentration') {
  <!-- 7. Concentration -->
  <section id="concentration" class="ifrs-section">
    <h2 class="ifrs-section-title">7. Concentration and mix</h2>
    <p class="ifrs-desc">Contract count and premium by portfolio and product.</p>
    <h3 class="ifrs-h3">Contract count by portfolio</h3>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Portfolio</th><th>Count</th></tr></thead>
        <tbody>
          @for (p of portfolios; track p) {
            <tr><td>{{ p }}</td><td class="num">{{ byPortfolio[p].count }}</td></tr>
          }
        </tbody>
      </table>
    </div>
    <h3 class="ifrs-h3">Premium by portfolio</h3>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Portfolio</th><th>Gross premium</th><th>Ceded</th><th>Net</th></tr></thead>
        <tbody>
          @for (p of portfolios; track p) {
            <tr>
              <td>{{ p }}</td>
              <td class="num">{{ fmtNum(byPortfolio[p].premium) }}</td>
              <td class="num">—</td>
              <td class="num">—</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'discount') {
  <!-- 8. Discount rates -->
  <section id="discount" class="ifrs-section">
    <h2 class="ifrs-section-title">8. Discount rates and curve</h2>
    <p class="ifrs-desc">Yield curve as at reporting date for discounting fulfilment cash flows.</p>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Term (years)</th><th>Rate %</th><th>As at date</th></tr></thead>
        <tbody>
          @for (r of disc; track r.term_years) {
            <tr>
              <td>{{ r.term_years }}</td>
              <td class="num">{{ fmtPct(r.rate_pct) }}</td>
              <td>{{ r.as_at_date }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'assumptions') {
  <!-- 9. Assumptions -->
  <section id="assumptions" class="ifrs-section">
    <h2 class="ifrs-section-title">9. Assumptions summary (disclosure)</h2>
    <p class="ifrs-desc">Significant assumptions used in measurement for disclosure.</p>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Portfolio</th><th>Assumption type</th><th>Value %</th><th>Effective date</th><th>Description</th></tr></thead>
        <tbody>
          @for (r of assump; track r.portfolio + r.assumption_type) {
            <tr>
              <td>{{ r.portfolio }}</td><td>{{ r.assumption_type }}</td>
              <td class="num">{{ fmtPct(r.value_pct) }}</td><td>{{ r.effective_date }}</td>
              <td>{{ r.description }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'balances') {
  <!-- 10. Balances -->
  <section id="balances" class="ifrs-section">
    <h2 class="ifrs-section-title">10. Statement of financial position extracts</h2>
    <p class="ifrs-desc">Insurance contract liabilities and reinsurance contract assets at reporting date.</p>
    <div class="summary-box"><strong>Insurance contract liabilities (total closing):</strong> {{ fmtNum(totalLiabilityClose) }} {{ currency }}</div>
    <div class="summary-box"><strong>Reinsurance contract assets (total):</strong> {{ fmtNum(totalReinAsset) }} {{ currency }}</div>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Portfolio</th><th>Cohort</th><th>Closing liability</th></tr></thead>
        <tbody>
          @for (r of lm; track r.portfolio + r.cohort_year) {
            <tr><td>{{ r.portfolio }}</td><td>{{ r.cohort_year }}</td><td class="num">{{ fmtNum(r.closing_balance) }}</td></tr>
          }
          <tr class="total"><td>Total</td><td></td><td class="num">{{ fmtNum(totalLiabilityClose) }}</td></tr>
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'new-business') {
  <!-- 11. New business -->
  <section id="new-business" class="ifrs-section">
    <h2 class="ifrs-section-title">11. New business and cohort growth</h2>
    <p class="ifrs-desc">Contracts by cohort and portfolio; new business from liability movements.</p>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Contract</th><th>Portfolio</th><th>Product</th><th>Cohort</th><th>Model</th><th>Inception</th><th>Coverage end</th></tr></thead>
        <tbody>
          @for (r of contracts; track r.contract_id) {
            <tr>
              <td>{{ r.contract_id }}</td><td>{{ r.portfolio }}</td><td>{{ r.product }}</td>
              <td>{{ r.cohort_year }}</td><td>{{ r.measurement_model }}</td>
              <td>{{ r.inception_date }}</td><td>{{ r.coverage_end_date }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  @if (currentSection() === 'reserves') {
  <!-- 12. Claims reserves -->
  <section id="reserves" class="ifrs-section">
    <h2 class="ifrs-section-title">12. Claims reserve and payment pattern</h2>
    <p class="ifrs-desc">Outstanding reserves and paid vs incurred by claim.</p>
    <div class="summary-box">
      <strong>Total incurred:</strong> {{ fmtNum(totalIncurred) }} {{ currency }} |
      <strong>Total paid:</strong> {{ fmtNum(totalPaid) }} {{ currency }} |
      <strong>Outstanding reserve:</strong> {{ fmtNum(totalOutstanding) }} {{ currency }}
    </div>
    <div class="ifrs-table-wrap">
      <table class="ifrs-table">
        <thead><tr><th>Contract</th><th>Claim</th><th>Incurred date</th><th>Incurred amount</th><th>Paid amount</th><th>Outstanding reserve</th></tr></thead>
        <tbody>
          @for (r of cl; track r.claim_id) {
            <tr>
              <td>{{ r.contract_id }}</td><td>{{ r.claim_id }}</td><td>{{ r.incurred_date || '—' }}</td>
              <td class="num">{{ fmtNum(r.incurred_amount) }}</td><td class="num">{{ fmtNum(r.paid_amount) }}</td>
              <td class="num">{{ fmtNum(r.outstanding_reserve) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }
</div>
